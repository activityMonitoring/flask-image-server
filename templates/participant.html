{% extends "layout.html" %}

{% set im_width=100 %}
{% set im_height=87 %}
{% set im_padding=10 %}
{% set im_both=im_width+im_padding %}
{% set im_half=im_both/2 %}

{% block head %}
    <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />
    <link rel="stylesheet" href="/static/jquery-ui-1.10.0.custom.min.css" />
    <link rel="stylesheet" href="/static/jquery.ui.timepicker.css" />
    <script src="/static/jquery.ui.timepicker.js"></script>
{% endblock %}
{% block title %}
	Participant: {{name}} 
{% endblock %}
{% block style %}
.img {
	margin: 0px;
	float: left;
	width: {{im_both}}px;
	height: 190px;
	text-align:center
}
.img :after {
	content: '';
    display: block;
    clear: both;
}
.shadow-wrapper:after {
    clear:both;
    content:" ";
    display:block;
}
.circle {
	stroke: lightblue;
	stroke-width:5;
	fill:white;
	cursor: grab;
	cursor: -webkit-grab;
}
.timepicker {
	margin: 5px;
	float: left;
}
.split {
	fill-opacity:0;
	z-index:10;
}
{% endblock %}
{% block content %}
	<div id="left-bar" style="position: absolute; padding: 10px; background: rgba(255,255,255,0.5); overflow: hidden; width: 180px">
		{% if schema is not none %}
		<div id="jstree_box"  style="display:none;">
			<input type="text" id="jstree_searchbox" style="padding:4px; border-radius:4px; border:1px solid silver;">
			<div id="jstree">
				<ul>
					{% set root = schema.root_folders %}
					{% for folder in root recursive  %} 

						<li>{{ folder.name }}
							<ul>{{ loop(folder.folders) }}
							{% for label in folder.labels %}
							<li data-jstree='{"icon":""}'> {{ label.name }} </li>
							{% endfor %}
							</ul>
						</li>
					{% endfor %}
				</ul>
			</div>
		</div>
		{% else %}
			<p>No root folder</p>
		{% endif %}
	</div>

	<div style="float:left; margin-left: 200px;">
		{% if days|length >0 %}
		<div class="clearfix" style="disply:inline-block; margin-bottom: 20px">
			{% set curr_day = None %}
			{% for day in days %}
				<div class="timepicker" hours="{% for hour in days[day] %}{{hour}} {% endfor %}" date="{{day}}"></div>
				{% if curr_day != (day.split("-")[2]|int - 1) and day.split("-")[2] is not none %}
					<div style="height:40px; float: left; margin-top:45px;">...</div>
				{% endif %}
				{% set curr_day = day.split("-")[2]|int %}
			{% endfor %}
		</div>
		{% endif %}

		{% if event_id %}
			<h3> Event ID: {{event_id}} <h3>
			{% if event_seconds %}
				<h3> Length: {{event_seconds | verbose_seconds}}</h3>
			{% endif%}
			<button onclick="Event.check_valid({{id}}, {{event_id}}, function(result) {$('#valid_result').html(result);})">Check valid</button><p id="valid_result"></p>
		{% endif %}

		{% if daterange is defined and daterange is not none %}
		<p> date range : {{daterange.min}} - {{daterange.max}} </p>
		{% endif %}

		<h3>Showing {{images | length}} images out of {{num_images}}</h3>
		<div style=" padding-left:30px; padding-right:30px;" class="shadow-wrapper">
			<div style="text-align:left;float:left;margin:5px;">
				{% if prev_event_id %} 
					<a style="float:left;clear:left;" href="/participant/{{id}}/{{prev_event_id}}">prev event</a>
				{% endif %}
				{% if prev_image %} 
					<a style="float:left;clear:left;" href="{{prev_image.full_url}}"><img width="100" height="74" src='{{prev_image.thumbnail_url}}' ></a>
					<button style="float:left;clear:left;" onclick="Event.add_image({{id}}, {{event_id}}, {{prev_image.image_id}}, function(result) {$('#prev_result').html(result);location.reload();})">Add prev image</button><p id="prev_result"></p>
				{% endif %}
			</div> 
			<div style="text-align:right;float:right;margin:5px;">
				{% if next_event_id %}  
					<a style="float:left;clear:left;" href="/participant/{{id}}/{{next_event_id}}">next event</a>
				{% endif %}
				{% if next_image %} 
					<a style="float:left;clear:left;" href="{{next_image.full_url}}"><img width="100" height="74" src='{{next_image.thumbnail_url}}' ></a>
					<button style="float:left;clear:left;" onclick="Event.add_image({{id}}, {{event_id}}, {{next_image.image_id}}, function(result) {$('#next_result').html(result);location.reload();})">Add next image</button><p id="next_result"></p>
				{% endif %}
			</div> 
		</div>
		<div class="shadow-wrapper">
		{% set fillcol="lightblue" %}
		{% for image in images %}
			 <div class="img" id="{{loop.index}}" image-id="{{image.image_id}}" event-id="{{image.event.event_id}}" is-last="{{image.is_last}}" is-first="{{image.is_first}}">
		 		<svg width="{{im_both}}" height="30">
		 			{% if image.event is not none %}			 	
					 	{% if not image.is_last %}
					 		<rect width="{{im_half}}" height="15" x="{{im_half}}" y="15" fill="yellow" style="cursor:col-resize;" class="split right" split-dir="right" /> 
					 	{% endif %} 
					 	{% if not image.is_first %}
					 		<rect width="{{im_half}}" height="15" x="0" y="15" fill="yellow" style="cursor:col-resize;" class="split left" split-dir="left" /> 
					 	{% endif %} 
					 	{% if not (image.is_last and image.is_first) %}
						 	{% if image.is_last %}
						 		<rect class="line" nw="{{im_half}}" width="{{im_half}}" height="5" nx="0" x="0" y="12.5" fill="{{fillcol}}" id="{{image.image_id}}" /> 
						 	{% elif image.is_first %}
						 		<rect class="line" nw="{{im_half}}" width="{{im_half}}" height="5" nx="{{im_half}}" x="{{im_half}}" y="12.5" fill="{{fillcol}}" id="{{image.image_id}}" /> 
						 	{% else %}
						 		<rect class="line" nw="{{im_both}}" width="{{im_both}}" height="5" nx="0" x="0" y="12.5" fill="{{fillcol}}" id="{{image.image_id}}"/> 
						 	{% endif %} 
						{% else %}
					 		<rect class="line" nw="0" width="0" height="5" nx="{{im_half}}" x="{{im_half}}" y="12.5" fill="{{fillcol}}" id="{{image.image_id}}"/> 
					 	{% endif %} 
					{% else %}
				 		<rect class="line" nw="0" width="0" height="5" nx="{{im_half}}" x="{{im_half}}" y="12.5" fill="{{fillcol}}" id="{{image.image_id}}"/> 
					{% endif %}
				 	{% if image.is_last or image.is_first %}
				 		<circle cx="{{im_half}}" cy="15" r="10" class="circle" id="{{image.image_id}}"/>
				 	{% else %}
				 		<circle cx="{{im_half}}" cy="15" r="10" class="circle hidden" id="{{image.image_id}}" visibility="hidden"/>
					{% endif %}
				</svg>
			 	<a href='{{image.full_url}}'><img width="{{im_width}}" height="{{87}}" src='{{image.thumbnail_url}}' ></a>
			 	 <a id="{{image.image_time}}" href="{% if image.event_id %}/participant/{{id}}/{{image.event_id}}{% endif %}">{{image.event_id}} - {{image.image_id}}</a> <p>{{ '%02d:%02d:%02d' % (image.image_time.hour, image.image_time.minute, image.image_time.second) }}</p> 
			 </div>
		{% else %}
			<p>No images</p>
		{% endfor %}
		</div>
	</div>
	<script>
	// SCRIPT FOR DATE/HOUR BOXES
	function urlByHour(hour, div) {
		var day = $(this).attr("date")
		var hour = parseInt(hour)
		// console.log(hour,"date_min="+day+"T"+hour+":00:00&date_max="+day+"T"+(hour+1)+":00:00")
		 window.location.href =  "/participant/{{id}}?" + "date_min="+day+"T"+hour+":00:00&date_max="+day+"T"+(hour+1)+":00:00"
		 console.log(window.location.href)
		 // document.location.search = "date_min="+day+"T"+hour+":00:00&date_max="+day+"T"+(hour+1)+":00:00"
	}
	function urlByDate(date, div) {
		console.log(date)
		// console.log(hour,"date_min="+day+"T"+hour+":00:00&date_max="+day+"T"+(hour+1)+":00:00")
		 window.location.href =  "/participant/{{id}}?"+ "date_min="+date+"T00:00:00&date_max="+date+"T23:59:59"
		 console.log(window.location.href)
		 // document.location.search = "date_min="+date+"T00:00:00&date_max="+date+"T23:59:59"
	}
	function onHourShow(hour) {
		return $.inArray(hour.toString(), $(this).attr("hours").split(" "))>-1;
	}
	$('.timepicker').timepicker({
		showMinutes:false,
		onHourShow:onHourShow,
		onSelect:urlByHour,
		showLeadingZero: false,
		defaultTime: ''
	});
	$('.timepicker').each(function() {
		$(this).find(".ui-timepicker-title").html("<a style='display:inline;' onclick='urlByDate(\""+$(this).attr("date")+"\")'>"+$(this).attr("date") + "</a>")
	})



	// SCRIPT FOR ANNOTATION FOLDER
	$(function () {
		$('#jstree').on('loaded.jstree', function() {
			console.log("loaded")
			$('#jstree_box').show()
		}).jstree({
			"core" : {
				"multiple" : false,
				"animation" : 0,
				"check_callback" : true
			},
			"plugins" : [ "search",  "contextmenu"  ]
		}); 
		var to = false;
		$('#jstree_searchbox').keyup(function () {
			if(to) { clearTimeout(to); }
			to = setTimeout(function () {
				var v = $('#jstree_searchbox').val();
				$('#jstree').jstree(true).search(v, {show_only_matches:true});
			}, 250);
		});
	});

	// SLIDE OUT SIDE ANNOTATION BAR
    var left_col_expanded = false;
    var left_bar_width = 180;
	function expand_left_col() { // on
	        var fn = function() { console.log("done")};
	        // if (!left_col_expanded) {fn = function() {console.log("done and resize");if (chart.flush) chart.flush(); resizeLayout(true)};} // must resize if chart area squished by drawer
	        var max_width = left_bar_width+left_col_expanded*500;
	        console.log(left_col_expanded ? "on" : "off", max_width, $('#left-bar')[0].scrollWidth)
	        // console.log(Lbottom[0].scrollWidth)
	        $('#left-bar').stop().animate({width:Math.min(max_width, Math.max(left_bar_width, $('#left-bar')[0].scrollWidth))}, {duration: 200, done: fn});
	        // Rcol.stop().animate({marginLeft:Math.min(max_width, Math.max(left_bar_width, Lbottom[0].scrollWidth))}, {duration: 200});
	    }
	$('#left-bar').hover(
	    function() {
	        // console.log('on');
	        left_col_expanded = true;
	        // $('#left-bar').css({"width":""})
	        expand_left_col();
	    }, 
	    function() { // off
	        // console.log('off');
	        left_col_expanded = false;
	        // $('#left-bar').css({"overflow":"hidden", width:200})
	        expand_left_col();
	    }
	);
	$("#jstree").on('click', function() {
		// console.log("click")
		left_col_expanded = true;
		expand_left_col();
	});

		function reset_all() {
			$(".circle.hidden").attr("visibility", "hidden");
			$(".circle").attr("cx", {{im_half}});
			$(".fake").remove();
		}
		 var dragging = null;
		 var drag_id = null;
		 var drag_event_id = null;
		 var drag_pair = null;
		 var drag_pair_id = null;
		 $(document).mouseup(function() {
		 	if (dragging) reset_all()
		 	dragging = null;
		 	reset_img($(".img"))
		 })
		 $('circle').mousedown(function(e) {
		 	e.preventDefault();
		 	dragging = $(this).closest(".img");
		 	drag_id = $(dragging).attr('id');
		 	drag_event_id = $(dragging).attr('event-id')
		 	drag_pair = $("[event-id="+drag_event_id+"]").filter( "[is-first='True'],[is-last='True']" ).not(dragging);
		 	drag_pair = (drag_pair.length==0) ? null : $(drag_pair[0]);
		 	drag_pair_id = (drag_pair == null) ? null : $(drag_pair).attr('id') ;
		 	console.log(drag_id, drag_pair_id)
		 });
		$('.img').mousemove(function(e) {
			if (dragging) {
				e.preventDefault()
				var this_id = $(this).attr('id');
				var this_event_id = $(this).attr('event-id');
				var same_event = (this_event_id == drag_event_id)
				console.log(this_id, drag_id, same_event)
				var move = e.pageX - $(this).offset().left
				$(".circle.hidden").attr("visibility", "hidden");
				console.log($(".circle.fake"))
				$(".fake").remove();
				if (this_id != drag_id) {
					// if (drag_pair!=null) {
					// 	if (drag_pair_id < 
					// }
					var between = $("#"+Math.min(this_id, drag_id)).nextUntil("#"+Math.max(this_id, drag_id))
					// console.log($(".line").not(between))
					line_full(between)
					hide_circle(between)

					// show_circle(this)
					reset_img($(".img").not(between))
					
					$(".img").not(between).find(".circle:not(.hidden)").attr("visibility","visible")
					// pull the original img
					if (this_id>drag_id) pull_away(dragging, {{im_both}}, true)
					else				 pull_away(dragging, 0, true)
					hide_circle(dragging)
					// move our cursor circle
					move_fake_circle(this, move)
					var trespassing = false; // TODO
					// pull the line into new frame
					// if within same event coming from opposite direction
					if (same_event && (is_first(this) || is_last(this))) { // shrinking own event
						line_from_mid(this, move);
					}
					else if (!same_event ? (this_id>drag_id) : (this_id<drag_id)) { 
						line_from_left(this, move)
					} else {
						line_from_right(this,move)
					}
				} else {
					// on same img as started
					show_circle(this)
					reset_img($(".img").not(this));
					pull_away(this, move)
				}
			}
		});
		function event_id(el) {return int($(el).attr("event-id") || null) }
		function is_first(el) {return $(el).attr("is-first")=="True";}
		function is_last(el) {return $(el).attr("is-last")=="True";}
		function pull_away(el, move, c) {
			var first = is_first(el);
			var last = is_last(el);
			if (first && !last) {
				from_right(el,move, c);
			}
			else if (last && !first) {
				from_left(el,move, c);
			} else {
				from_mid(el, move, c);
			}
		}

		function from_mid(el, move, c) {
			if (move>{{im_half}}) {
				$(el).find(".line").attr({"width":move-{{im_half}}, "x":{{im_half}}});
				if (!c) move_circle_continuous(el, move);
				else move_circle(el, move);
			} else {
				$(el).find(".line").attr({"width":{{im_half}}-move, "x":move});
				if (!c) move_circle_continuous(el, move);
				else move_circle(el, move);	
			}
		}
		function from_left(el, move, c, no_circ) {
			$(el).find(".line").attr({"width":move, "x":0});
			if (!c) move_circle_continuous(el, move);
			else move_circle(el, move);	
		}
		function from_right(el, move, c, no_circ) {
			$(el).find(".line").attr({"width":{{im_both}}-move, "x":move});
			if (!c) move_circle_continuous(el, move);
			else move_circle(el, move);	
		}

		function line_from_mid(el, move, c) {
			if (move>{{im_half}}) {
				makeLine(el,{"width":move-{{im_half}} });
			} else {
				makeLine(el,{"width":{{im_half}}-move})
			}
		}
		function line_from_left(el, move, c, no_circ) {
			makeLine(el,{"width":move, "x":0})
		}
		function line_from_right(el, move, c, no_circ) {
			makeLine(el,{"width":{{im_both}}-move, "x":move})
		}

		function move_circle(el, move) {
			$(el).find(".circle").attr("cx",  move)
			return el;
		}
		function move_circle_continuous(el, move) {
			move_circle(el, move);
			if (move>{{im_both}}-15) move_fake_circle($(el).next(".img"), move-{{im_both}});
			if (move<15) move_fake_circle($(el).prev(".img"), {{im_both}}+move);
		}
		function move_fake_circle(el, move) {
			$(el).find("svg").append(makeSVG("circle", {"cx":move, "cy":10, "r":10, "class":"circle fake"}));
			return el;
		}

		function hide_circle(el) {
			$(el).find(".circle").attr("visibility","hidden");
		}
		function show_circle(el) {
			$(el).find(".circle").attr("visibility","visible");
		}

		function line_full(el) {
			$(el).find(".line").attr({"width":150, "x":0});
		}
		function reset_img(el) {
			$(el).find(".circle:not(.hidden)").attr("visibility","visible").attr("cx", {{im_half}});
			$(el).find(".line").each(function(){
				$(this).attr({"width":$(this).attr("nw"), "x":$(this).attr("nx")});
			});
		}

		$('.split').click(function() {
			me = $(this)
			var image_id = me.closest(".img").attr("image-id");
			var event_id = me.closest(".img").attr("event-id");
			var dir = me.attr("split-dir");
			Event.split(dir, {{id}},event_id, image_id, function(status) {
				if (status=="success") location.reload();
				else {
					console.log(status);
					me.attr("fill", "red")
				}
			});
		}).hover(function(){
			var dir = $(this).attr("split-dir");
			var img = $(this).closest(".img")
			console.log(this, dir) 
			if (dir=="left") {
				makeSeperator(img, {'x':10})
				makeSeperator(img.prev(".img"), {'x':{{im_both}}-10})
			} 
			if (dir=="right") {
				makeSeperator(img, {'x':{{im_both}}-10})
				makeSeperator(img.next(".img"), {'x':10})
			}
		}, function() {
			$(".fake").remove()
		});
		$('circle').hover(function() {
			$(this).attr("r", 10) // was 10
		}, function() {
			$(this).attr("r", 10)
		});

		$('.img').hover(function() {
			$(this).find("img").animate({ "width": {{im_width * 1.03}}, "height" :{{87 * 1.03}}}, "fast");
		}, function() {
			$(this).find("img").animate({ "width": {{im_width}}, "height" :{{87}}}, "fast");
		});
		function makeSeperator(el, attrs) {
			attrs['class'] = 'fake'
			attrs['height'] = 20
			attrs['width'] = 5
			attrs['fill'] = "{{fillcol}}"
			attrs['y'] = 5
			$(el).find("svg").prepend(makeSVG("rect",attrs));
			// if attrs[]
			// $(el).find("svg").prepend(makeSVG("rect",attrs));
			console.log($(el).closest("svg")[0])
		}
		function makeLine(el, attrs) {
			attrs['class'] = 'fake'
			attrs['height'] = 5
			attrs['fill'] = "{{fillcol}}"
			attrs['y'] = 15
			console.log(attrs)
			$(el).find("svg").append(makeSVG("rect",attrs));
		}

		function makeSVG(tag, attrs) {
            var el= document.createElementNS('http://www.w3.org/2000/svg', tag);
            for (var k in attrs)
                el.setAttribute(k, attrs[k]);
            return el;
        }

	</script>
{% endblock %}
