{% extends "layout.html" %}

{% set im_width=100 %}
{% set im_padding=10 %}
{% set im_both=im_width+im_padding %}
{% set im_half=im_both/2 %}

{% block head %}
    <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />
{% endblock %}
{% block title %}
	Participant
{% endblock %}
{% block style %}
	.img {
		margin: 0px;
		float: left;
		width: {{im_both}}px;
		height: 190px;
		text-align:center
	}
	.img :after {
		content: '';
	    display: block;
	    clear: both;
	}
	.shadow-wrapper:after {
	    clear:both;
	    content:" ";
	    display:block;
	}
	.circle {
		stroke: lightblue;
		stroke-width:5;
		fill:white;
		cursor: grab;
		cursor: -webkit-grab;
	}
	.circle:hover {
		stroke-width:3;
	}

{% endblock %}
{% block content %}
	<h2> Participant: {{name}} (showing {{images | length}} images out of {{num_images}})</h2>
	{% if event_id %}
		<h3> Event ID: {{event_id}} <h3>
		{% if event_seconds %}
			<h3> Length: {{event_seconds | verbose_seconds}}</h3>
		{% endif%}
		<button onclick="Event.check_valid({{id}}, {{event_id}}, function(result) {$('#valid_result').html(result);})">Check valid</button><p id="valid_result"></p>
	{% endif%}
	<div id="jstree">
		<ul>
			{% for label in schema.labels %} 
				<li>{{ label.name }}</li>
			{% endfor %}
		</ul>
	</div>

	<p> date range : {{daterange.min}} - {{daterange.max}}
	{% for day in days %}
		<h3> {{day}} </h3>
		{% for hour in days[day] %}
			<a href="/participant/{{id}}?date_min={{day}}T{{hour}}:00:00&date_max={{day}}T{{hour+1}}:00:00">
				<p>{{day}} {{hour}}:00 - {{days[day][hour]}} images</p> 
			</a>
		{% endfor %}
	{% endfor %}

	<div style=" padding-left:30px; padding-right:30px;" class="shadow-wrapper">
		<div style="text-align:left;float:left;margin:5px;">
			{% if prev_event_id %} 
				<a style="float:left;clear:left;" href="/participant/{{id}}/{{prev_event_id}}">prev event</a>
			{% endif %}
			{% if prev_image %} 
				<a style="float:left;clear:left;" href="{{prev_image.full_url}}"><img width="100" height="74" src='{{prev_image.thumbnail_url}}' ></a>
				<button style="float:left;clear:left;" onclick="Event.add_image({{id}}, {{event_id}}, {{prev_image.image_id}}, function(result) {$('#prev_result').html(result);location.reload();})">Add prev image</button><p id="prev_result"></p>
			{% endif %}
		</div> 
		<div style="text-align:right;float:right;margin:5px;">
			{% if next_event_id %}  
				<a style="float:left;clear:left;" href="/participant/{{id}}/{{next_event_id}}">next event</a>
			{% endif %}
			{% if next_image %} 
				<a style="float:left;clear:left;" href="{{next_image.full_url}}"><img width="100" height="74" src='{{next_image.thumbnail_url}}' ></a>
				<button style="float:left;clear:left;" onclick="Event.add_image({{id}}, {{event_id}}, {{next_image.image_id}}, function(result) {$('#next_result').html(result);location.reload();})">Add next image</button><p id="next_result"></p>
			{% endif %}
		</div> 
	</div>
	<div style="width:100%;padding:30px;" class="shadow-wrapper">
	{% set fillcol="lightblue" %}
	{% for image in images %}
		 <div class="img" id="{{image.image_id}}" image-id="{{image.image_id}}" event-id="{{image.event.event_id}}" is-last="{{image.is_last}}" is-first="{{image.is_first}}">
	 		<svg width="{{im_both}}" height="30">
	 			{% if image.event is not none %}			 	
				 	{% if not image.is_last %}
				 		<rect width="{{im_half}}" height="15" x="{{im_half}}" y="15" fill="yellow" style="cursor:col-resize;" class="split right" split-dir="right" /> 
				 	{% endif %} 
				 	{% if not image.is_first %}
				 		<rect width="{{im_half}}" height="15" x="0" y="15" fill="yellow" style="cursor:col-resize;" class="split left" split-dir="left" /> 
				 	{% endif %} 
				 	{% if not (image.is_last and image.is_first) %}
					 	{% if image.is_last %}
					 		<rect class="line" nw="{{im_half}}" width="{{im_half}}" height="5" nx="0" x="0" y="12.5" fill="{{fillcol}}" id="{{image.image_id}}" /> 
					 	{% elif image.is_first %}
					 		<rect class="line" nw="{{im_half}}" width="{{im_half}}" height="5" nx="{{im_half}}" x="{{im_half}}" y="12.5" fill="{{fillcol}}" id="{{image.image_id}}" /> 
					 	{% else %}
					 		<rect class="line" nw="{{im_both}}" width="{{im_both}}" height="5" nx="0" x="0" y="12.5" fill="{{fillcol}}" id="{{image.image_id}}"/> 
					 	{% endif %} 
					{% else %}
				 		<rect class="line" nw="0" width="0" height="5" nx="{{im_half}}" x="{{im_half}}" y="12.5" fill="{{fillcol}}" id="{{image.image_id}}"/> 
				 	{% endif %} 
				 	{% if image.is_last or image.is_first %}
				 		<circle cx="{{im_half}}" cy="15" r="10" class="circle" id="{{image.image_id}}"/>
					{% endif %}
				{% else %}
			 		<rect class="line" nw="0" width="0" height="5" nx="{{im_half}}" x="{{im_half}}" y="12.5" fill="{{fillcol}}" id="{{image.image_id}}"/> 
				{% endif %}
			</svg>
		 	<a href='{{image.full_url}}'><img width="" height="74" src='{{image.thumbnail_url}}' ></a>
		 	 <a id="{{image.image_time}}" href="{% if image.event_id %}/participant/{{id}}/{{image.event_id}}{% endif %}">{{image.event_id}} - {{image.image_id}}</a> <p>{{ '%02d:%02d:%02d' % (image.image_time.hour, image.image_time.minute, image.image_time.second) }}</p> 
		 </div>
	{% else %}
		<p>No images</p>
	{% endfor %}
	</div>
	<script>
	$(function () {
		$('#jstree').jstree({
			"core" : {
				"multiple" : false,
				"animation" : 0,
				"check_callback" : true
			},
			"plugins" : [ "search",  "contextmenu"  ]
		}); 

	});
	/*
	function Image(index, image_id, event_id, thumb_url, width, full_url, time, is_first)  {
		this.index = index;
		this.image_id = image_id;
		this.event_id = event_id;
		this.time = time;
		this.width = width;
		this.thumb_url = thumb_url;
		this.full_url = full_url;
		this.div = null;
	}
	Image.prototype.generateHTML = function() {
		
		self.div = $('<div class="img"><a href="'+self.full_url+'"><img width="'+self.width+'" height="74" src='+self.thumb_url+' ></a></div>').appendTo(".shadow-wrapper") 
		if (self.event_id!=null) $('<a id="'+self.time+'" href="/participant/{{id}}/'+self.event_id+'">event '+self.event_id+'</a>').appendTo(self.div)

	}
	Image.prototype.genSVG = function() {
		$('<svg width="{{im_both}}" height="30">').appendTo(self.div)
	}
	var images = [{image_id: }
	function() {
		if (dragging!=null) {

		}
	}
		  */
		 var dragging = null;
		 var drag_id = null;
		 var drag_event_id = null;
		 $(document).mouseup(function() {
		 	dragging = null;
		 	drag_id = null;
		 	reset_img($(".img"))
		 })
		 $('circle').mousedown(function(e) {
		 	e.preventDefault();
		 	dragging = $(this).closest(".img");
		 	drag_id = $(dragging).attr('id')
		 	drag_event_id = $(dragging).attr('event-id')
		 });
		$('.img').mousemove(function(e) {
			if (dragging) {
				e.preventDefault()
				var this_id = $(this).attr('id');
				var this_event_id = $(this).attr('event-id');
				var same_event = (this_event_id == drag_event_id)
				console.log(this_id, drag_id, same_event)
				var move = e.pageX - $(this).offset().left
				if (this_id != drag_id) {
					var between = $("#"+Math.min(this_id, drag_id)).nextUntil("#"+Math.max(this_id, drag_id))
					// console.log($(".line").not(between))
					line_full(between)
					hide_circle(between)
					hide_circle(this)
					reset_img($(".img").not(between))
					
					$(".img").not(between).find(".circle").attr("visibility","visible")
					// pull the original img
					if (this_id>drag_id) pull_away(dragging, {{im_both}})
					else				 pull_away(dragging, 0)
					if (same_event && (is_first(this) || is_last(this))) { // shrinking own event
						from_mid(this, move);
					}
					// pull this into new frame
					// if within same event coming from opposite direction
					else if (!same_event ? (this_id>drag_id) : (this_id<drag_id)) { 
						from_left(this, move)
					} else {
						from_right(this,move)
					}
				} else {
					// on same img as started
					reset_img($(".img").not(this));
					pull_away(this, move)
				}
			}
		});
		function is_first(el) {return $(el).attr("is-first")=="True";}
		function is_last(el) {return $(el).attr("is-last")=="True";}
		function pull_away(el, move) {
			var first = is_first(el);
			var last = is_last(el);
			if (first && !last) {
				from_right(el,move);
			}
			else if (last && !first) {
				from_left(el,move);
			} else {
				from_mid(el, move);
			}
		}
		function from_mid(el, move) {
			if (move>{{im_half}}) {
				$(el).find(".line").attr({"width":move-{{im_half}}, "x":{{im_half}}});
			} else {
				$(el).find(".line").attr({"width":{{im_half}}-move, "x":move});
			}
		}
		function from_left(el, move) {
			$(el).find(".line").attr({"width":move, "x":0});
			move_circle_continuous(el, move);
		}
		function from_right(el, move) {
			$(el).find(".line").attr({"width":{{im_both}}-move, "x":move});
			move_circle_continuous(el, move);
		}
		function move_circle(el, move) {
			$(el).find(".circle").attr("cx",  move)
		}
		function move_circle_continuous(el, move) {
			move_circle(el, move);
			if (move>{{im_both}}-10) move_circle($(el).next(".img"), move-{{im_both}});
			if (move<10) move_circle($(el).prev(".img"), {{im_both}}+move);
		}
		function hide_circle(el) {
			$(el).find(".circle").attr("visibility","hidden");
		}
		function line_full(el) {
			$(el).find(".line").attr({"width":150, "x":0});
		}
		function reset_img(el) {
			$(el).find(".circle").attr("visibility","visible");
			$(el).find(".line").each(function(){
				$(this).attr({"width":$(this).attr("nw"), "x":$(this).attr("nx")});
			});
		}

		$('.split').click(function() {
			me = $(this)
			var image_id = me.closest(".img").attr("image-id");
			var event_id = me.closest(".img").attr("event-id");
			var dir = me.attr("split-dir");
			Event.split(dir, {{id}},event_id, image_id, function(status) {
				if (status=="success") location.reload();
				else {
					console.log(status);
					me.attr("fill", "red")
				}
			});
		});
		$('circle').hover(function() {
			$(this).attr("r", 10) // was 10
		}, function() {
			$(this).attr("r", 10)
		});
		// $('circle').draggable()
		//   .bind('mousedown', function(event, ui){
		//   	console.log($(this).attr("cx"))
		//   	$(this).attr("originalX", $(this).attr("cx")-event.target.parentNode.offsetLeft)
		//     // bring target to front
		//     $(event.target).appendTo( "#wrap" );
		//   }).mouseup(function(event, ui){
		//   	$(this).removeAttr("originalX")
		//   }).bind('drag', function(event, ui){
		// 	var it = $(event.target);
		//     // update coordinates manually, since top/left style props don't work on SVG
		//     it.attr('cx', event.clientX);
		//     // it.attr('cy', ui.position.top-ui.originalPosition.top);
		//     console.log(it.attr("cx"), it.attr("cy"), event)
		//   })
	</script>
{% endblock %}
