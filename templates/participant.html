{% extends "layout.html" %}

{% set im_width=100 %}
{% set im_height=87 %}
{% set im_padding=10 %}
{% set im_both=im_width+im_padding %}
{% set im_half=im_both/2 %}

{% block head %}
    <script src="/static/jquery-ui.js"></script>
    <script src="/static/jstree.min.js"></script>
    <link rel="stylesheet" href="/static/style.min.css" />
    <link rel="stylesheet" href="/static/jquery-ui-1.10.0.custom.min.css" />
    <link rel="stylesheet" href="/static/jquery.ui.timepicker.css" />
    <script src="/static/jquery.ui.timepicker.js"></script>
    <style>
    .img {
    	margin: 0px;
    	float: left;
    	width: {{im_both}}px;
    	height: 190px;
    	text-align:center;
    	position:relative;
    }
    .img :after {
    	content: '';
        display: block;
        clear: both;
    }
    .shadow-wrapper:after {
        clear:both;
        content:" ";
        display:block;
    }
    .circle {
    	stroke: lightblue;
    	stroke-width:5;
    	fill:white;
    	cursor: grab;
    	cursor: -webkit-grab;
    }
    .timepicker {
    	margin: 5px;
    	float: left;
    }
    .split {
    	fill-opacity:0;
    	z-index:10;
    	/*background-color: yellow;*/
    	width: {{im_half/3}}px;
    	height:30px;
    	top:0px;
    	position:absolute;
    	cursor:col-resize;
    }
    li.jstree-leaf > a .jstree-icon { display: none; }
    </style>
{% endblock %}
{% block title %}
	Participant: {{name}} 
{% endblock %}
{% block content %}
	<div id="left-bar" style="position: absolute; padding:10px; background: rgba(255,255,255,0.5); overflow: hidden; width: 180px">
		{% if schema is not none %}
		<div id="jstree_box"  style="display:none;">
			<input type="text" id="jstree_searchbox" style="padding:4px; border-radius:4px; border:1px solid silver;">
			<div id="jstree">
				<ul>
					{% set root = schema.root_folders %}
					{% for folder in root recursive  %} 

						<li>{{ folder.name }}
							<ul>{{ loop(folder.folders) }}
							{% for label in folder.labels %}
							<li label-id="{{ label.label_id }}"> {{ label.name }} </li>
							{% endfor %}
							</ul>
						</li>
					{% endfor %}
				</ul>
			</div>
		</div>
		{% else %}
			<p>No root folder</p>
		{% endif %}
	</div>

	<div style="float:left; margin-left: 200px;">
		{% if days|length >0 %}
		<div class="clearfix" style="display:inline-block; margin-bottom: 20px; overflow-y:scroll; height:140px;width:100%">
		{% for i in [1,2,3,4,5,6,7,8] %}
			{% set curr_day = None %}
			{% for day in days %}
				<div class="timepicker" hours="{% for hour in days[day] %}{{hour}} {% endfor %}" date="{{day}}"></div>
				{% if curr_day != (day.split("-")[2]|int - 1) and day.split("-")[2] is not none %}
					<div style="height:40px; float: left; margin-top:45px;">...</div>
				{% endif %}
				{% set curr_day = day.split("-")[2]|int %}
			{% endfor %}
		{% endfor %}
		</div>
		{% endif %}

		{% if event_id %}
			<h3> Event ID: {{event_id}} <h3>
			{% if event_seconds %}
				<h3> Length: {{event_seconds | verbose_seconds}}</h3>
			{% endif%}
			<button onclick="Event.check_valid({{id}}, {{event_id}}, function(result) {$('#valid_result').html(result);})">Check valid</button><p id="valid_result"></p>
		{% endif %}

		{% if daterange is defined and daterange is not none %}
		<p> date range : {{daterange.min}} - {{daterange.max}} </p>
		{% endif %}

		<h3>Showing {{images | length}} images out of {{num_images}}</h3>
		<div style=" padding-left:30px; padding-right:30px;" class="shadow-wrapper">
			<div style="text-align:left;float:left;margin:5px;">
				{% if prev_event_id %} 
					<a style="float:left;clear:left;" href="/participant/{{id}}/{{prev_event_id}}">prev event</a>
				{% endif %}
				{% if prev_image %} 
					<a style="float:left;clear:left;" href="{{prev_image.full_url}}"><img width="100" height="74" src='{{prev_image.thumbnail_url}}' ></a>
					<button style="float:left;clear:left;" onclick="Event.add_image({{id}}, {{event_id}}, {{prev_image.image_id}}, function(result) {$('#prev_result').html(result);reload_page();})">Add prev image</button><p id="prev_result"></p>
				{% endif %}
			</div> 
			<div style="text-align:right;float:right;margin:5px;">
				{% if next_event_id %}  
					<a style="float:left;clear:left;" href="/participant/{{id}}/{{next_event_id}}">next event</a>
				{% endif %}
				{% if next_image %} 
					<a style="float:left;clear:left;" href="{{next_image.full_url}}"><img width="100" height="74" src='{{next_image.thumbnail_url}}' ></a>
					<button style="float:left;clear:left;" onclick="Event.add_image({{id}}, {{event_id}}, {{next_image.image_id}}, function(result) {$('#next_result').html(result);reload_page();})">Add next image</button><p id="next_result"></p>
				{% endif %}
			</div> 
		</div>
		<div class="shadow-wrapper">
		{% set fillcol="lightblue" %}
		{% for image in images %}
			<div class="img" id="{{loop.index}}" image-id="{{image.image_id}}" event-id="{{image.event.event_id}}" is-last="{{image.is_last}}" is-first="{{image.is_first}}">
	 			{% if image.event is not none %}			 	
				 	{% if not image.is_last %}
						 <div style="left:{{im_half*5/3}}px;" class="split right" split-dir="right"></div>
				 	{% endif %}
				 	{% if not image.is_first %}
						 <div style="left:0px;" class="split left" split-dir="left"></div>
				 	{% endif %} 
			 	{% endif %} 
		 		<svg width="{{im_both}}" height="30">

		 			{% if image.event is not none %}			 	

					 	{% if not (image.is_last and image.is_first) %}
						 	{% if image.is_last %}
						 		<rect class="line" nw="{{im_half}}" width="{{im_half}}" height="5" nx="0" x="0" y="12.5" fill="{{fillcol}}" id="{{image.image_id}}" /> 
						 	{% elif image.is_first %}
						 		<rect class="line" nw="{{im_half}}" width="{{im_half}}" height="5" nx="{{im_half}}" x="{{im_half}}" y="12.5" fill="{{fillcol}}" id="{{image.image_id}}" /> 
						 	{% else %}
						 		<rect class="line" nw="{{im_both}}" width="{{im_both}}" height="5" nx="0" x="0" y="12.5" fill="{{fillcol}}" id="{{image.image_id}}"/> 
						 	{% endif %} 
						{% else %}
					 		<rect class="line" nw="0" width="0" height="5" nx="{{im_half}}" x="{{im_half}}" y="12.5" fill="{{fillcol}}" id="{{image.image_id}}"/> 
					 	{% endif %} 
					{% else %}
				 		<rect class="line" nw="0" width="0" height="5" nx="{{im_half}}" x="{{im_half}}" y="12.5" fill="{{fillcol}}" id="{{image.image_id}}"/> 
					{% endif %}
				 	{% if image.is_last or image.is_first %}
				 		<circle cx="{{im_half}}" cy="15" r="10" class="circle" id="{{image.image_id}}"/>
				 	{% else %}
				 		<circle cx="{{im_half}}" cy="15" r="10" class="circle hidden" id="{{image.image_id}}" visibility="hidden"/>
					{% endif %}

				</svg>
			 	<a href='{{image.full_url}}'><img width="{{im_width}}" height="{{87}}" src='{{image.thumbnail_url}}' ></a>
			 	 <a id="{{image.image_time}}" href="{% if image.event_id %}/participant/{{id}}/{{image.event_id}}{% endif %}">{{image.event_id}} - {{image.image_id}}</a> <p>{{ '%02d:%02d:%02d' % (image.image_time.hour, image.image_time.minute, image.image_time.second) }}</p> 
			 </div>
		{% else %}
			<p>No images</p>
		{% endfor %}
		</div>
	</div>
	<script>
	function reload_page() {
		console.log("reloading page..")
		location.reload()
	}
	// SCRIPT FOR DATE/HOUR BOXES
	function urlByHour(hour, div) {
		var day = $(this).attr("date")
		var hour = parseInt(hour)
		// console.log(hour,"date_min="+day+"T"+hour+":00:00&date_max="+day+"T"+(hour+1)+":00:00")
		 window.location.href =  "/participant/{{id}}?" + "date_min="+day+"T"+hour+":00:00&date_max="+day+"T"+(hour+1)+":00:00"
		 console.log(window.location.href)
		 // document.location.search = "date_min="+day+"T"+hour+":00:00&date_max="+day+"T"+(hour+1)+":00:00"
	}
	function urlByDate(date, div) {
		console.log(date)
		// console.log(hour,"date_min="+day+"T"+hour+":00:00&date_max="+day+"T"+(hour+1)+":00:00")
		 window.location.href =  "/participant/{{id}}?"+ "date_min="+date+"T00:00:00&date_max="+date+"T23:59:59"
		 console.log(window.location.href)
		 // document.location.search = "date_min="+date+"T00:00:00&date_max="+date+"T23:59:59"
	}
	function onHourShow(hour) {
		return $.inArray(hour.toString(), $(this).attr("hours").split(" "))>-1;
	}
	$('.timepicker').timepicker({
		showMinutes:false,
		onHourShow:onHourShow,
		onSelect:urlByHour,
		showLeadingZero: false,
		defaultTime: ''
	});
	$('.timepicker').each(function() {
		$(this).find(".ui-timepicker-title").html("<a style='display:inline;' onclick='urlByDate(\""+$(this).attr("date")+"\")'>"+$(this).attr("date") + "</a>")
	})



	// SCRIPT FOR ANNOTATION FOLDER
	var dragging_annotation = false;
	$(function () {
		$('#jstree').on('loaded.jstree', function() {
			console.log("loaded")
			$('#jstree_box').show()
		}).on('drag.jstree', function(e) {
			// if (dragging_annotation==false) {
			// 	dragging_annotation = parseInt($(e.target).closest("li").attr("label-id"));
			// 	if (!isNaN(dragging_annotation)) {
			// 		console.log("drag", dragging_annotation);
			// 		left_col_expanded = false;
			// 		expand_left_col();
			// 	} else {
			// 		console.log("dragging_annotation failed",e.target, $(e.target).closest("li"), $(e.target).closest(".jstree-node[label-id]"));
			// 		dragging_annotation = false;
			// 		e.preventDefault()
			// 	}
			// }
		}).jstree({
			"core" : {
				"multiple" : false,
				"animation" : 0,
				"check_callback" : true
			},
			"plugins" : [ "search" /*,  "contextmenu"*/  ],
			"search" :  {
				"case_insensitive" : true,
				"show_only_matches":true
			}
		}); 
		var to = false;
		$('#jstree_searchbox').keyup(function () {
			if(to) { clearTimeout(to); }
			to = setTimeout(function () {
				var v = $('#jstree_searchbox').val();
				$('#jstree').jstree(true).search(v);
			}, 250);
		});
	});

	// SLIDE OUT SIDE ANNOTATION BAR
    var left_col_expanded = false;
    var left_bar_width = 180;
	function expand_left_col() { // on
	        var fn = function() { console.log("done")};
	        var max_width = left_bar_width+left_col_expanded*500;
	        console.log(left_col_expanded ? "on" : "off", max_width, $('#left-bar')[0].scrollWidth)
	        // console.log(Lbottom[0].scrollWidth)
	        $('#left-bar').stop().animate({
	        	width:Math.min(max_width, Math.max(left_bar_width, $('#left-bar')[0].scrollWidth))
	        }, {duration: 200, done: fn});
	    }
	$('#left-bar').hover(
	    function() {
	        if (dragging_annotation===false) {
		        left_col_expanded = true;
		        // $('#left-bar').css({"width":""})
		        expand_left_col();
		    }
	    }, 
	    function() { // off
	        // console.log('off');
	        left_col_expanded = false;
	        // $('#left-bar').css({"overflow":"hidden", width:200})
	        expand_left_col();
	    }
	);
	$("#jstree").on('click', function() {
		console.log("click");
		left_col_expanded = true;
		expand_left_col();
	});
	$("div.img").mouseup(function() {
			if (dragging_annotation) {
				var event_id = parseInt($(this).attr("event-id"))
				console.log("Event_annotate!", event_id)
				// Event.annotate(participant_id, event_id, label_id, complete)
				Event.annotate({{id}}, event_id, dragging_annotation, function(e) {alert("done" + e);})
			} else {
				console.log("no annotation", dragging_annotation)
			}
		});


	// EVENT MANIPULATION
		function reset_all() {
			$(".circle.hidden").attr("visibility", "hidden");
			$(".circle:not(.hidden)").attr("visibility", "visible");
			$(".fake").remove();
			$(".line").attr("visibility", "visible");
		}

		var curr_img = null;
		var curr_id = null;
		var start_img = null;
		var start_id = null;
		var start_event_id = null;
		var event_pair_img = null;
		var event_pair_id = null;
		var event_to_left = null;
		var event_to_left_is_standalone = null;
		var event_to_right = null;
		var event_to_right_is_standalone = null;
		var selection_is_expanding = null;
		$('.img').mouseup(function() {
			if (start_img!=null && start_id != curr_id) {
				console.log("mouseup on ", this);
				image_id = $(curr_img).attr("image-id");
				if (image_id===undefined) return false;
				if (selection_is_expanding==true) {
					console.log("db.add_image("+{{id}}+","+start_event_id+","+image_id+")")
					Event.add_image({{id}}, start_event_id, image_id, reload_page)
				}
				if (selection_is_expanding==false) {
					if (curr_id > start_id) var direction = "left"
					else var direction = "right"
					console.log("db.remove_image("+{{id}}+","+start_event_id+","+image_id+","+direction+")")
					// need to make sure don't remove the last image in the event!
					Event.remove_image({{id}}, start_event_id, image_id, direction, reload_page)
				}
			}
		})
		 $(document).mouseup(function() {
		 	if (start_img!==null) reset_all()
		 	curr_img = null;
		 	curr_id = null;
		 	start_img = null;
		 	start_id = null;
		 	start_event_id = null;
		 	event_pair_img = null;
		 	event_pair_id = null;
		 	event_to_left = null;
		 	event_to_right = null;
		 	event_to_left_is_standalone = null;
		 	event_to_right_is_standalone = null;
		 	selection_is_expanding = null;
		 })

		$('circle').mousedown(function(e) {
			e.preventDefault()
			start_img = curr_img = $(this).closest("div.img")[0];
			start_img_is_standalone = ( $(start_img).attr('is-first')=="True" && $(start_img).attr('is-last')=="True" )
			start_id  = curr_id  = parseInt(start_img.id)
			start_event_id = parseInt($(start_img).attr('event-id'));
			// find other 'end' of event (if none set to null)
			event_pair_img = $("[event-id="+start_event_id+"]").filter( "[is-first='True'],[is-last='True']" ).not(start_img);
			event_pair_img = (event_pair_img.length==0) ? null : event_pair_img[0];
			event_pair_id = (event_pair_img == null) ? null : parseInt($(event_pair_img).attr('id'));
			// check sides for another event
			var left = $("div#"+(start_id-1)+".img")
			var right = $("div#"+(start_id+1)+".img")
			if (left.length == 1 && left.attr("event-id").length != 0) {
				event_to_left = parseInt(left.attr("id"))
				event_to_left_is_standalone = (left.attr("is-first")=="True" && left.attr("event-id") != start_event_id)
			} else event_to_left = false;
			if (right.length == 1 && right.attr("event-id").length != 0) {
				event_to_right = parseInt(right.attr("id"))
				event_to_right_is_standalone = (right.attr("is-last")=="True" && right.attr("event-id") != start_event_id)
			} else event_to_right = false;
			console.log(event_to_left, event_to_right, left, right)
			console.log(this, curr_img, event_pair_img)
		});

		$('.img').mousemove(function(e) {
			if (start_img===null) {return 0;}
			e.preventDefault()
			// if it has moved from previous position
			if (this !== curr_img) {
				// make sure we can not move futher back than the end of the event
				curr_id = parseInt(this.id);
				// if we have gone further than the other end of our own event
				if (event_pair_id!==null && (
					(start_id < event_pair_id && curr_id > event_pair_id) || 
					(start_id > event_pair_id && curr_id < event_pair_id) 
					)) {
					// limit the movement
					curr_id = event_pair_id;
					// re-check that we have moved
					if (curr_img==event_pair_img) return 0;
					curr_img = event_pair_img;
				} else {
					curr_img = this;
				}
				curr_event_id = parseInt($(curr_img).attr('event-id'));
				var same_event = (curr_event_id == start_event_id)

				// create dict of id's to modify
				var modify = {}
				// if same id as started do nothing
				if (!(start_id == curr_id)) {

					if (same_event) {
						selection_is_expanding = false;
						// if shrinking own event, hide parts that will no longer exist
						if (start_id < curr_id) {
							// moving towards left, this does the strike-through
							for( var i=start_id; i<curr_id; i++ ){
								if (event_to_left!==false) modify[i] = "through"
								else modify[i] = "blank"
		 					}
		 					if (curr_id !== event_pair_id) modify[curr_id] = "from-right";
		 					else modify[curr_id] = "standalone"; // if event is now only 1-img long
		 					if (event_to_left!==false) {
		 						modify[curr_id-1] = "from-left";
		 						if (event_to_left_is_standalone) modify[event_to_left] = "from-right"
		 						else modify[event_to_left] = "through"
		 					}
		 				} else {
							// moving towards right
		 					for( var i=start_id; i>curr_id; i-- ){
								if (event_to_right!==false) modify[i] = "through"
								else modify[i] = "blank"
		 					}
		 					if (curr_id !== event_pair_id) modify[curr_id] = "from-left"
		 					else modify[curr_id] = "standalone"; // if event is now only 1-img long
		 					if (event_to_right!==false) {
		 						modify[curr_id+1] = "from-right"
		 						if (event_to_right_is_standalone) modify[event_to_right] = "from-left"
		 						else modify[event_to_right] = "through"
		 					}
		 				}
					} else {
						// must be expanding into another event:
						selection_is_expanding = true;
						if (start_id < curr_id) {
							// moving towards right
							console.log("moving towards right")
							// strike-through images behind move
							for( var i=start_id; i<curr_id; i++ ){
								modify[i] = "through"
							}
							// unless we're dragging from a singleton
							if (start_img_is_standalone) modify[start_id] = "from-right"
							modify[curr_id] = "from-left";

							var img_on_right = $("div#"+(curr_id+1)+".img");
							if (img_on_right.length==1) {
								if (img_on_right.attr("event-id")!=="") {
									if (img_on_right.attr("is-last")=="True") modify[curr_id+1] = "standalone"
									else modify[curr_id+1] = "from-right"
								}
							}
						} else {
							// moving towards left
							console.log("moving towards left")

							for( var i=start_id; i>curr_id; i-- ){
								modify[i] = "through"
							}
							if (start_img_is_standalone) modify[start_id] = "from-left"
							modify[curr_id] = "from-right";

							var img_on_left = $("div#"+(curr_id-1)+".img");
							if (img_on_left.length==1) {
								if (img_on_left.attr("event-id")!=="") {
									if (img_on_left.attr("is-first")=="True") modify[curr_id-1] = "standalone"
									else modify[curr_id-1] = "from-left"
								}
							}
						}
					}
				}
				reset_all()
 				for (i in modify) {
 					console.log(i, modify[i])
 					modify_img(i, modify[i]);
 				}
				console.log("moved" ,same_event ? "same_event" : "", start_id, curr_id)
			}
		});
		function modify_img(id, state) {
			var img = $("div#"+id+".img")
			var svg = img.find("svg")
			if (state=="from-left") {
				svg.find(".line:not(.fake)").attr("visibility","hidden");
				makeLine(svg, {"x":0,"width":{{im_half}} })
				if (svg.find(".circle:not(.fake)").length!==1) makeCircle(svg);
				else svg.find(".circle:not(.fake)").attr("visibility","visible")
			}
			else if (state=="from-right") {
				svg.find(".line:not(.fake)").attr("visibility","hidden");
				makeLine(svg, {"x":{{im_half}},"width":{{im_half}} })
				if (svg.find(".circle:not(.fake)").length!==1) makeCircle(svg);
				else svg.find(".circle:not(.fake)").attr("visibility","visible")
			} else if (state=="standalone") {
				svg.find(".line:not(.fake)").attr("visibility","hidden");
				if (svg.find(".circle:not(.fake)").length!==1) makeCircle(svg);
				else svg.find(".circle:not(.fake)").attr("visibility","visible")
			} else if (state=="through") {
				svg.find(".line:not(.fake)").attr("visibility","hidden");
				makeLine(svg, {"x":0,"width":{{im_both}} })
				svg.find(".circle").attr("visibility","hidden")
			} else if (state=="blank") {
				svg.find(".line").attr("visibility","hidden");
				svg.find(".circle").attr("visibility","hidden")
			}
		}

		function makeCircle(el) {
			el.append(makeSVG("circle", {"cx":{{im_half}}, "cy":15, "r":10, "class":"circle fake"}));
		}
		function makeLine(el, attrs) {
			attrs['class'] = 'line fake'
			attrs['height'] = 5
			attrs['fill'] = "{{fillcol}}"
			attrs['y'] = 12.5
			attrs['z-index'] = 5
			// console.log(attrs)
			el.prepend(makeSVG("rect",attrs));
		}

		function makeSVG(tag, attrs) {
            var el= document.createElementNS('http://www.w3.org/2000/svg', tag);
            for (var k in attrs)
                el.setAttribute(k, attrs[k]);
            return el;
        }


        $('.split').click(function() {
        	me = $(this)
        	var image_id = me.closest(".img").attr("image-id");
        	var event_id = me.closest(".img").attr("event-id");
        	var dir = me.attr("split-dir");
        	Event.split(dir, {{id}},event_id, image_id, function(status) {
        		if (status=="success") reload_page();
        		else {
        			console.log(status);
        			me.attr("fill", "red")
        		}
        	});
        }).hover(function(){
        	if (start_img!==null) return 0;
        	var dir = $(this).attr("split-dir");
        	var img = $(this).closest(".img")
        	if (dir=="left") {
        		makeSeperator(img, {'x':10})
        		makeSeperator(img.prev(".img"), {'x':{{im_both}}-10})
        	} 
        	if (dir=="right") {
        		makeSeperator(img, {'x':{{im_both}}-10})
        		makeSeperator(img.next(".img"), {'x':10})
        	}
        }, function() {
        	$(".fake.seperator").remove()
        });

        function makeSeperator(el, attrs) {
        	attrs['fill'] = "{{fillcol}}"
        	attrs['width'] = 5
        	makeSeperatorLine(el, attrs);
        	attrs['fill'] = "white"
        	attrs['width'] = 15
        	attrs['x'] +=  (attrs['x']>{{im_half}} ? 5 : -attrs['width'])
        	makeSeperatorLine(el, attrs);
        }
        	
        function makeSeperatorLine(el, attrs) {
        	attrs['class'] = 'fake seperator'
        	attrs['height'] = 20
        	attrs['y'] = 5
        	$(el).find("svg").append(makeSVG("rect",attrs));
        }




	</script>
{% endblock %}
