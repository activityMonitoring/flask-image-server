{% extends "layout.html" %}

{% set im_width=100 %}
{% set im_height=87 %}
{% set im_padding=10 %}
{% set im_both=im_width+im_padding %}
{% set im_half=im_both/2 %}

{% block head %}
    <script src="http://127.0.0.1:5001/static/jquery-ui.js"></script>
    <script src="http://127.0.0.1:5001/static/jstree.min.js"></script>
    <link rel="stylesheet" href="http://127.0.0.1:5001/static/style.min.css" />
    <link rel="stylesheet" href="http://127.0.0.1:5001/static/jquery-ui-1.10.0.custom.min.css" />
    <link rel="stylesheet" href="http://127.0.0.1:5001/static/jquery.ui.timepicker.css" />
    <script src="http://127.0.0.1:5001/static/jquery.ui.timepicker.js"></script>

    <!-- Photoswipe -->
    <!-- Core CSS file -->
    <link rel="stylesheet" href="http://127.0.0.1:5001/static/photoswipe/photoswipe.css"> 
    <!-- Skin CSS file -->
    <link rel="stylesheet" href="http://127.0.0.1:5001/static/photoswipe/default-skin/default-skin.css"> 
    <!-- Core JS file -->
    <script src="http://127.0.0.1:5001/static/photoswipe/photoswipe.min.js"></script>
    <!-- UI JS file -->
    <script src="http://127.0.0.1:5001/static/photoswipe/photoswipe-ui-default.min.js"></script> 

    <style>
    .img {
    	margin: 0px;
    	float: left;
    	width: {{im_both}}px;
    	height: 190px;
    	text-align:center;
    	position:relative;
    }
    .img :after {
    	content: '';
        display: block;
        clear: both;
    }
    .img.selected {
    	background-color: lightcyan;
    	-webkit-transition: background-color 0.3s;
    	transition: background-color 0.3s;
    }
    img.thumbnail {
    	cursor:pointer;
    }
    .gallery:after {
        clear:both;
        content:" ";
        display:block;
    }
    .circle {
    	stroke: lightblue;
    	stroke-width:5;
    	fill:white;
    	cursor: grab;
    	cursor: -webkit-grab;
    }
    .timepicker {
    	margin: 5px;
    	float: left;
    }
    .ui-timepicker-title {
    	/*background-color:lightblue;*/
    }
    .split {
    	fill-opacity:0;
    	z-index:10;
    	/*background-color: yellow;*/
    	height:30px;
    	top:0px;
    	position:absolute;
    }
    .split.left {
    	cursor:col-resize;
    	width: {{im_half/3}}px;
    	left:0px;
	}
    .split.right {
    	cursor:col-resize;
    	width: {{im_half/3}}px;
    	left:{{im_half*5/3}}px
    }
    .split.between {
    	cursor:pointer;
    	left:{{im_half/3}}px;
    	width: {{im_half*4/3}}px;
    }
    li.jstree-leaf > a .jstree-icon { display: none; }
    #right-bar {
    	float:left; margin-left: 200px;
    }
    #calendar-box { 
		display:inline-block;
		margin-bottom: 20px;
		overflow-y:auto; 
		height:170px;
		width:100%;
    }
    /*stick to top after scroll*/
    .left-sticky {
		position: absolute;
		padding-left:10px;
		overflow-y: auto; 
		overflow-x: hidden; 
		width: 180px;
		z-index:10;
		background-color: {{bg_color_a}};
    	padding-right: 1px;
	}
    .left-sticky:hover {
/*    	border-right: 1px solid rgba(100,100,100,0.5);
    	-webkit-transition: border-right 0.3s;
    	transition: border-right 0.3s;*/
    }
	.left-sticky.fix-search {
	    position: fixed;
	    top: 0px;
	    height: 100%;
	  }
	 #dropdown-box {
	 	position:absolute;
	 	top:55px;
	 	height:0px;
	 	z-index:12;
	 	background-color:white;
	 	width:100%;
	 	border-bottom:1px solid #444;
	 	padding-left:20px;
	 	padding-right:20px;
	 	overflow: hidden;
	 	display: block;
	 	/*visibility: hidden;*/
	 }
	 #dropdown-box:hover {
	 	/*visibility: visible;*/
	 }
    </style>
{% endblock %}
{% block pagename %} Participant: {{name}} {% endblock %}
{% block title %}
	<a style="color:black; padding:10px;margin:-10px;display:inline-block;" href="/participant/{{id}}" id="title-link"> Participant: {{name}} </a>
{% endblock %}
{% block content %}

	<div id="dropdown-box">

		{% if daterange is defined and daterange is not none %}
			<h3>Showing {{daterange.diff | verbose_seconds}} starting at {{daterange.min | verbose_date}} </h3>
		{% endif %}

		<h4>Showing {{images | length}} images out of {{num_images}}</h4>
		<div class="clearfix" id="calendar-box">
		{% if days|length >0 %}
		{% set curr_day = None %}
		{% for day in days %}
			<div class="timepicker" hours="{% for hour in days[day] %}{{hour}} {% endfor %}" date="{{day}}"></div>
			{% if 0 and curr_day != (day.split("-")[2]|int - 1) and day.split("-")[2] is not none %}
				<!-- <div style="height:40px; float: left; margin-top:45px;">...</div> -->
			{% endif %}
			{% set curr_day = day.split("-")[2]|int %}
		{% endfor %}
		{% endif %}
		</div>
	</div>
	<div class="left-sticky" id="left-bar">
{% if schema is not none -%}
<div id="jstree_box"  style="display:none;">
	<input type="text" id="jstree_searchbox" style="padding:4px; border-radius:4px; border:1px solid silver; margin-top:10px;">
	<div id="jstree">
		<ul>
			{% set root = schema.root_folders -%}
			{% for folder in root recursive  -%} 
				<li>{{ name.folder }}
					<ul>{{ loop(folder.folders) }}
					{% for label in folder.labels -%}
					<li  draggable="true" ondragstart="jstree_drag(event)" label-id="{{ label.label_id }}" {%if label.color%} label-color="{{label.color}}" {%endif%}> {{ label.name }} </li>
					{% endfor -%}
					</ul>
				</li>
			{% endfor -%}
		</ul>
	</div>
</div>
{% else -%}
	<p>No root folder</p>
{% endif -%}
	</div>

	<div id="right-bar">
		{% set fillcol="lightblue" -%}
		<div class="gallery">
		</div>
	</div>

	<!-- Root element of PhotoSwipe. Must have class pswp. -->
	<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

	    <!-- Background of PhotoSwipe. 
	         It's a separate element as animating opacity is faster than rgba(). -->
	    <div class="pswp__bg"></div>

	    <!-- Slides wrapper with overflow:hidden. -->
	    <div class="pswp__scroll-wrap">

	        <!-- Container that holds slides. 
	            PhotoSwipe keeps only 3 of them in the DOM to save memory.
	            Don't modify these 3 pswp__item elements, data is added later on. -->
	        <div class="pswp__container">
	            <div class="pswp__item"></div>
	            <div class="pswp__item"></div>
	            <div class="pswp__item"></div>
	        </div>

	        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
	        <div class="pswp__ui pswp__ui--hidden">

	            <div class="pswp__top-bar">

	                <!--  Controls are self-explanatory. Order can be changed. -->

	                <div class="pswp__counter"></div>

	                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

	                <button class="pswp__button pswp__button--share" title="Share"></button>

	                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

	                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

	                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
	                <!-- element will get class pswp__preloader--active when preloader is running -->
	                <div class="pswp__preloader">
	                    <div class="pswp__preloader__icn">
	                      <div class="pswp__preloader__cut">
	                        <div class="pswp__preloader__donut"></div>
	                      </div>
	                    </div>
	                </div>
	            </div>

	            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
	                <div class="pswp__share-tooltip"></div> 
	            </div>

	            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
	            </button>

	            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
	            </button>

	            <div class="pswp__caption">
	                <div class="pswp__caption__center"></div>
	            </div>

	        </div>

	    </div>

	</div>
	<script>
	var time_start = new Date()
	var imgs;
	var img_sizes = {
		thumbnail: [{{im_width}}, {{im_height}}],
		medium: [864,645],
		original: [2592,1936]
	}
	var evts;
	$(function() {

		var time_load = new Date()
		evts = {{evts_json | safe}};
		imgs = {{imgs_json | safe}}
		console.log("imgs & evts done", (new Date() - time_load)/1000+"s","   from load:",(new Date() - time_start)/1000+"s")
		// var idx = 0;
		var html = "";
		imgs.forEach(function(img, idx) {
			html += create_image(img, idx);
			// idx++;
		})
		$(".gallery").html(html)
		console.log("gallery done", (new Date() - time_load)/1000+"s","   from load:",(new Date() - time_start)/1000+"s")
		eventize_images()
		console.log("eventize done", (new Date() - time_load)/1000+"s","   from load:",(new Date() - time_start)/1000+"s")
		$("div.img").each(function(i, el) {
			svg_ize($(el), i);
		})
		console.log("svg_ize done", (new Date() - time_load)/1000+"s","   from load:",(new Date() - time_start)/1000+"s")
		// $("div.img").each(function() {})
		// image = {
		// 	image_id: function()
		// }
		function date_compare(a, b) {
			// python function for generating these dates is:
			// def serialize_datetime(d):
			//     return [d.year, d.month, d.day, d.hour, d.minute, d.second]

			for (var i = 0; i <= 6; i++) {
				if (a[i]<b[i]) return -(i+1); // b<a
				if (a[i]>b[i]) return (i+1);  // a>b
			}
			return 0; // equal
		}

		function create_image(i, idx) { 

			var image_id=i[0], event_id=i[1], full_url=i[4][2], thumbnail_url=i[4][0], image_time=i[3],is_last=i[5][1], is_first=i[5][0];
			var str = '<div class="img" id="'+idx+'" image-id="'+image_id+'" event-id="'+(event_id===null ? "" : event_id) +'" is-last="'+is_last+'" is-first="'+is_first+'"  ondrop="img_drop(event)" ondragover="img_hover(event)">'
		 	if (!(event_id!==undefined)) {			 	
				if (!is_last) {
					 str += '<div style="left:{{im_half*5/3}}px;" class="split right" split-dir="right"></div>'
				}
				if (!is_first) {
					str += '<div style="left:0px;" class="split left" split-dir="left"></div>'
				}
			}
			str += '<svg width="{{im_both}}" height="30">'

			str += '</svg>'
			str += '<img class="thumbnail" width="{{im_width}}" height="{{87}}" src="'+thumbnail_url+'" >'
			str += '<p>' + image_time[3]+':'+image_time[4]+':'+image_time[5]+'</p></div>'
			return str;
		}
		function eventize_images(idx_start, idx_end){
			imgs_i = idx_start || 0;
			imgs_len = idx_end!==undefined ? idx_end+1 : imgs.length;
			// imgs_len = imgs.length;
			evts_i = 0;
			evts_len = evts.length;
			// evts.forEach(function(e){
			// console.log(evts[evts_i], imgs_i)
			// console.log(imgs[imgs_i][3])

			// console.log(date_compare(evts[evts_i][3], imgs[imgs_i][3]))
			var already_checked_start = false;
			while(evts_i<evts_len && imgs_i<imgs_len) {
				var cmp = already_checked_start || date_compare(evts[evts_i][3][0], imgs[imgs_i][3])
				// console.log("cmp: ", cmp > 0 ? "e>i" : (cmp==0 ? "e=i" : "e<i"),cmp, evts[evts_i][3][0].join(",") + "  " , imgs[imgs_i][3].join(",")) 
				if (cmp==-1) {
					evts_i--;
					console.log('evts_i++ THIS SHOULDNT HAPPEN IF EVENTS NOT OVERLAPPING')

				} else {
					already_checked_start = true;
					cmp = date_compare(evts[evts_i][3][1], imgs[imgs_i][3])
					// console.log("cmp2:", cmp > 0 ? "e>i" : (cmp==0 ? "e=i" : "e<i"),cmp, evts[evts_i][3][1].join(",") + "  " , imgs[imgs_i][3].join(",")) 
					if (cmp>0) {
						// console.log(evts_i, imgs_i)
						imgs_i++;
					} else {
						// console.log(evts_i, imgs_i)
						evts_i++;
						already_checked_start = false;
					}
				}
			}
		}
		// EVENT python
		/*[self.event_id,
                self.label_id,
                self.comment,
                map(serialize_datetime, [self.start_time, self.end_time])]*/
        // IMAGE python
        /* [self.image_id, 
            self.event_id,
            self.participant_id,
            serialize_datetime(self.image_time), 
            map(self.gen_url, [self.thumbnail_url, self.medium_url, self.full_url]),
            [1 if self.is_first else 0, 1 if self.is_last else 0]
        ] */
		function svg_ize(el, i) {
			// var new_svg= makeSVG("svg", {width:{{im_both}}, height:30});
			// el.append(new_svg)
			var container = el.find("svg")
			var img = imgs[i];
			// console.log(el,i, img[0],img[5])
				if ((!img[1] && img[1]!==0)) {// || img[5][0] || img[5][1]) { // neither or no event
					console.log("neither or no event")
					makeLine(container, {width:0, nw:0, x:{{im_half}}, nx:{{im_half}}, id:img[0] }, true)
					//			 		<rect class="line" nw="0" width="0" height="5" nx="{{im_half}}" x="{{im_half}}" y="12.5" fill="{{fillcol}}" id="imageimage_id}}"/> 
				}
				else if (img[5][0] && img[5][1]) {
					// console.log("both")
					makeCircle(container,true)
					makeLine(container, {width:0, nw:0, x:{{im_half}}, nx:{{im_half}}, id:img[0]}, true)
					//				 		<rect class="line" nw="{{im_half}}" width="{{im_half}}" height="5" nx="0" x="0" y="12.5" fill="{{fillcol}}" id="{imageimage_id}}" /> 
				}
				else if (img[5][1]) { // is-last
					// console.log("last")
					makeCircle(container,true)
					makeLine(container, {width:{{im_half}}, nw:{{im_half}}, x:0, nx:0, id:img[0] }, true)
					el.prepend('<div class="split left" split-dir="left"></div>')
					//				 		<rect class="line" nw="{{im_half}}" width="{{im_half}}" height="5" nx="0" x="0" y="12.5" fill="{{fillcol}}" id="{image.image_id}}" /> 
				}
				else if (img[5][0]) { // is-first
					// console.log("first")
					makeCircle(container,true)
					makeLine(container, {width:{{im_half}}, nw:{{im_half}}, x:{{im_half}}, nx:{{im_half}}, id:img[0] }, true)
					el.prepend(' <div class="split right" split-dir="right"></div>')
					//				 		<rect class="line" nw="{{im_half}}" width="{{im_half}}" height="5" nx="{{im_half}}" x="{{im_half}}" y="12.5" fill="{{fillcol}}" id="{image.image_id}}" /> 
				}
				else if (!img[5][0] && !img[5][1]) { // connector
					// console.log("connector")
					el.prepend(' <div class="split right" split-dir="right"></div><div class="split left" split-dir="left"></div>')
					makeLine(container, {width:{{im_both}}, nw:{{im_both}}, x:0, nx:0, id:img[0] }, true)

					
				} else console.log("something went wrong")

		}
		$("img.thumbnail").click(function() { 
			// console.log($(this).closest(".img").attr("id"));
			// console.log(this);
			var idx = parseInt($(this).closest(".img").attr("id"))
			// console.log(idx);
			openPhotoSwipe(idx)
		})
	});
	</script>














	<script>
	function reload_page() {
		console.log("reloading page..")
		location.reload()
	}

	// show dropdown box but hide after 500ms 
	(function() {
		var t;
		var delay = 150;
		// $("#dropdown-box").slideUp(0);
		// $("#dropdown-box").css("visibility","visible");
		$("#dropdown-box, #title-link").hover(function() {
			// $("#dropdown-box").clearQueue().delay(delay).slideDown("slow")
			// display: block; visibility: visible; height: 6.87412px; margin-top: 0px; margin-bottom: 0px; padding-top: 0.539146px; padding-bottom: 0.539146px; overflow: hidden;
			// display: block; visibility: visible; height: 229.958px; padding-top: 18.0282px; margin-top: 0px; padding-bottom: 18.0282px; margin-bottom: 0px; overflow: hidden;
			$("#dropdown-box").clearQueue().delay(delay).animate({
				    "height": 255
				});
		},function() {
			$("#dropdown-box").clearQueue().delay(delay).animate({
				    "height": 0,
				});//.slideUp("slow")
		});
	})()

	// SCRIPT FOR DATE/HOUR BOXES
	var urlByDate;
	(function() {
		function urlByHour(hour, div) {
			var day = $(this).attr("date")
			var hour = parseInt(hour)
			// console.log(hour,"date_min="+day+"T"+hour+":00:00&date_max="+day+"T"+(hour+1)+":00:00")
			 window.location.href =  "/participant/{{id}}?" + "date_min="+day+"T"+hour+":00:00&date_max="+day+"T"+(hour+1)+":00:00"
			 console.log(window.location.href)
			 // document.location.search = "date_min="+day+"T"+hour+":00:00&date_max="+day+"T"+(hour+1)+":00:00"
		}
		urlByDate = function(date, div) {
			console.log(date)
			// console.log(hour,"date_min="+day+"T"+hour+":00:00&date_max="+day+"T"+(hour+1)+":00:00")
			 window.location.href =  "/participant/{{id}}?"+ "date_min="+date+"T00:00:00&date_max="+date+"T24:00:00"
			 console.log(window.location.href)
			 // document.location.search = "date_min="+date+"T00:00:00&date_max="+date+"T23:59:59"
		}
		function onHourShow(hour) {
			return $.inArray(hour.toString(), $(this).attr("hours").split(" "))>-1;
		}
		$('.timepicker').timepicker({
			showMinutes:false,
			onHourShow:onHourShow,
			onSelect:urlByHour,
			showLeadingZero: false,
			defaultTime: ''
		});
		$('.timepicker').each(function() {
			$(this).find(".ui-timepicker-title").html("<a style='display:inline;' onclick='urlByDate(\""+$(this).attr("date")+"\")'>"+$(this).attr("date") + "</a>")
		})
	})();






	// DRAG DROP FOR ANNOTATIONS
	// these are assigned in html attribute callbacks
	// see https://developer.mozilla.org/en-US/docs/Web/API/DataTransfer
	var jstree_drag, img_drop, img_hover;
	(function() {
		var label_id = null;
		var event_id = null;
		jstree_drag = function(ev) {
			console.log("drag",$("#jstree")[0], $.contains($("#jstree")[0],ev.target))
			if ($.contains($("#jstree")[0],ev.target)) {
				label_id =  $(ev.target).closest("li").attr("label-id")
			    ev.dataTransfer.setData("label-id", label_id);
			    console.log("drag labe_id = ",label_id,ev.dataTransfer.getData("label-id"))	
			    left_col_expanded = false;
			    expand_left_col();
			}
		}
		img_hover = function(ev) {
		    // var label_id = ev.dataTransfer.getData("label-id");
		    // if (!isNaN(parseInt(label_id))) {
		    if (label_id!==null) {
			    console.log("allowDrop", label_id, ".")
			    ev.preventDefault();
			    var new_event_id = $(ev.target).closest("div.img").attr("event-id");
			    // if changed..
		    	if (new_event_id!==event_id) {
			    	event_id = new_event_id;
		    		$("div.img").removeClass("selected");
		    		if (new_event_id!==undefined) {
			    		$("div.img[event-id="+event_id+"]").addClass("selected")
			    	}
		    	}
			}
		    else console.log("don'tallowDrop", label_id, ".", ev)
		}

		img_drop = function(ev) {
		    ev.preventDefault();
		    console.log("drop data:", label_id,"target: ", ev.target, $(ev.target).closest("div.img")[0])
		    if (label_id!==null) {
		    	event_id = $(ev.target).closest("div.img").attr("event-id")
		    	if (event_id!==undefined) {
		    		$("div.img[event-id="+event_id+"]").css("background-color", getRandomColor())
		    		Event.annotate({{id}}, event_id, label_id, function(e) {alert("done" + e);})
		    	}
			}
		}
		$(document).mouseup(function() {
			label_id = null;
		})
	})();

	function getRandomColor() {
	    var letters = '0123456789ABCDEF'.split('');
	    var color = '#';
	    for (var i = 0; i < 6; i++ ) {
	        color += letters[Math.floor(Math.random() * 16)];
	    }
	    return color;
	}





	// SCRIPT FOR ANNOTATION FOLDER
	(function() {
		var dragging_annotation = false;
		$(function () {
			$('#jstree').on('loaded.jstree', function() {
				$('#jstree_box').show()
			}).jstree({
				"core" : {
					"multiple" : false,
					"animation" : 0,
					"check_callback" : true
				},
				"plugins" : [ "search" /*,  "contextmenu"*/  ],
				"search" :  {
					"case_insensitive" : true,
					"show_only_matches":true
				}
			}).bind("select_node.jstree", function(e, node) {
				$("#jstree").jstree(true).toggle_node(node.node);
			}).bind("dblclick.jstree", function(e, node){
				$("#jstree").jstree(true).toggle_node(e.target);
			}).bind("move_node.jstree", function (e, data) {console.log("move_node",e, data)}); 
			var to = false;
			$('#jstree_searchbox').keyup(function () {
				if(to) { clearTimeout(to); }
				to = setTimeout(function () {
					var v = $('#jstree_searchbox').val();
					$('#jstree').jstree(true).search(v);
				}, 250);
			});
		});
	})();

	// SLIDE OUT SIDE ANNOTATION BAR
	var expand_left_col;
    var left_col_expanded = false;
    (function() {
	    var left_bar_width = 180;
		expand_left_col = function() { // on
		        // var fn = function() { console.log("done")};
		        var max_width = Math.min(left_bar_width+left_col_expanded*500, $( window ).width()*0.9);
		        console.log(left_col_expanded ? "on" : "off", max_width, $('#left-bar')[0].scrollWidth)
		        $('#left-bar').stop().animate({
		        	width:Math.min(max_width, Math.max(left_bar_width, $('#left-bar')[0].scrollWidth))
		        }, {duration: 200, done: null});
		    }
		$('#left-bar').hover(
		    function() { // on
		        // console.log('hover', is_dragging);
		        if (!is_dragging) {
			        left_col_expanded = true;
			        expand_left_col();
			    }
		    }, 
		    function() { // off
		        console.log('hover off');
		        left_col_expanded = false;
		        expand_left_col();
		    }
		);
		$("#jstree").on('click', function() {
			// console.log("click");
			left_col_expanded = true;
			expand_left_col();
		});
	})();











	// IMAGE SELECTION
	$(function() {
		$("div.img").click(function(e) {
			console.log("div.img")
			$("div.img").not(this).removeClass("selected")
			$(this).addClass("selected")
			var event_id = $(this).attr("event-id")
			if (event_id!=undefined)  
				$(".img[event-id="+event_id+"]").addClass("selected")
		})

		$("#right-bar").click(function() {
			console.log("gallery")
			 $("div.img").removeClass("selected")
		})
	});

	// EVENT MANIPULATION
	var is_dragging = false;
	$(function() {
			function reset_all() {
				console.log("reset_all()")
				$(".circle.hidden").attr("visibility", "hidden");
				$(".circle:not(.hidden)").attr("visibility", "visible");
				$(".fake").remove();
				$(".line").attr("visibility", "visible");
			}

			var start_img = null;
			var curr_img = null;
			var curr_id = null;
			var start_id = null;
			var start_event_id = null;
			var event_pair_img = null;
			var event_pair_id = null;
			var event_to_left = null;
			var event_to_left_is_standalone = null;
			var event_to_right = null;
			var event_to_right_is_standalone = null;
			var selection_is_expanding = null;

			 $(document).mouseup(function() {

			 	// modify event boundaries
				if (start_img!=null && start_id != curr_id) {
					console.log("mouseup on ", this);
					var image_id = $(curr_img).attr("image-id");
					if (image_id===undefined) return false;

					if (selection_is_expanding==true) {
						console.log("db.add_image("+{{id}}+","+start_event_id+","+image_id+")")
						Event.add_image({{id}}, start_event_id, image_id, reload_page)
					}
					if (selection_is_expanding==false) {
						if (curr_id > start_id) var direction = "left"
						else var direction = "right"
						// if (curr_id == event_pair_id) include_target = false;
						// else include_target = true;
						var include_target = false;
						console.log("db.remove_image("+{{id}}+","+start_event_id+","+image_id+","+direction+", "+include_target+")")
						// need to make sure don't remove the last image in the event!
						Event.remove_image({{id}}, start_event_id, image_id, direction, include_target,reload_page)
					}
					fix_appearance()	        	
				}
			 	else if (start_img!==null ) reset_all()
			 	curr_img = null;
			 	curr_id = null;
			 	start_img = null;
			 	start_id = null;
			 	start_event_id = null;
			 	event_pair_img = null;
			 	event_pair_id = null;
			 	// event id's of starting neighbouring events
			 	event_to_left = null;
			 	event_to_right = null;
			 	// used to make sure standalones 'drag' into the current event properly
			 	event_to_left_is_standalone = null;
			 	event_to_right_is_standalone = null;
			 	selection_is_expanding = null;
			 	is_dragging = false;
			 })

			$('circle').mousedown(function(e) {
				e.preventDefault()
				is_dragging = true;
				start_img = curr_img = $(this).closest("div.img")[0];
				start_img_is_standalone = ( $(start_img).attr('is-first')=="1" && $(start_img).attr('is-last')=="1" )
				start_id  = curr_id  = parseInt(start_img.id)
				start_event_id = parseInt($(start_img).attr('event-id'));
				// find other 'end' of event (if none set to null)
				event_pair_img = $("[event-id="+start_event_id+"]").filter( "[is-first='1'],[is-last='1']" ).not(start_img);
				event_pair_img = (event_pair_img.length==0) ? null : event_pair_img[0];
				event_pair_id = (event_pair_img == null) ? null : parseInt($(event_pair_img).attr('id'));
				// check sides for another event
				var left = $("div#"+(start_id-1)+".img")
				var right = $("div#"+(start_id+1)+".img")
				if (left.length == 1 && left.attr("event-id").length != 0) {
					event_to_left = parseInt(left.attr("id"))
					event_to_left_is_standalone = (left.attr("is-first")=="1" && left.attr("event-id") != start_event_id)
				} else event_to_left = false;
				if (right.length == 1 && right.attr("event-id").length != 0) {
					event_to_right = parseInt(right.attr("id"))
					event_to_right_is_standalone = (right.attr("is-last")=="1" && right.attr("event-id") != start_event_id)
				} else event_to_right = false;
				console.log('event_to_left:',event_to_left, 'event_to_right:',event_to_right, 'left:',left, 'right:',right)
				console.log('this:',this, 'curr_img:',curr_img, 'event_pair_img:',event_pair_img)
			});

			$('div.img').mousemove(function(e) {
				if (start_img===null) {return 0;}
				e.preventDefault()
				// if it has moved from previous position
				if (this !== curr_img) {
					// make sure we can not move futher back than the end of the event
					curr_id = parseInt(this.id);
					// if we have gone further than the other end of our own event
					if (event_pair_id!==null && (
						(start_id < event_pair_id && curr_id > event_pair_id) || 
						(start_id > event_pair_id && curr_id < event_pair_id) 
						)) {
						// limit the movement
						curr_id = event_pair_id;
						// re-check that we have moved
						if (curr_img==event_pair_img) return 0;
						curr_img = event_pair_img;
					} else {
						curr_img = this;
					}
					curr_event_id = parseInt($(curr_img).attr('event-id'));
					var same_event = (curr_event_id == start_event_id)

					// create dict of id's to modify
					var modify = {}
					// if same id as started do nothing
					if (!(start_id == curr_id)) {

						if (same_event) {
							selection_is_expanding = false;
							// if shrinking own event, hide parts that will no longer exist
							if (start_id < curr_id) {
								// moving towards left, this does the strike-through
								for( var i=start_id; i<curr_id; i++ ){
									if (event_to_left!==false) modify[i] = "through"
									else modify[i] = "blank"
			 					}
			 					if (curr_id !== event_pair_id) modify[curr_id] = "from-right";
			 					else modify[curr_id] = "standalone"; // if event is now only 1-img long
			 					if (event_to_left!==false) {
			 						modify[curr_id-1] = "from-left";
			 						if (event_to_left_is_standalone) modify[event_to_left] = "from-right"
			 						else modify[event_to_left] = "through"
			 					}
			 				} else {
								// moving towards right
			 					for( var i=start_id; i>curr_id; i-- ){
									if (event_to_right!==false) modify[i] = "through"
									else modify[i] = "blank"
			 					}
			 					if (curr_id !== event_pair_id) modify[curr_id] = "from-left"
			 					else modify[curr_id] = "standalone"; // if event is now only 1-img long
			 					if (event_to_right!==false) {
			 						modify[curr_id+1] = "from-right"
			 						if (event_to_right_is_standalone) modify[event_to_right] = "from-left"
			 						else modify[event_to_right] = "through"
			 					}
			 				}
						} else {
							// must be expanding into another event:
							selection_is_expanding = true;
							if (start_id < curr_id) {
								// moving towards right
								console.log("moving towards right")
								// strike-through images behind move
								for( var i=start_id; i<curr_id; i++ ){
									modify[i] = "through"
								}
								// unless we're dragging from a singleton
								if (start_img_is_standalone) modify[start_id] = "from-right"
								modify[curr_id] = "from-left";

								var img_on_right = $("div#"+(curr_id+1)+".img");
								if (img_on_right.length==1) {
									if (img_on_right.attr("event-id")!=="") {
										if (img_on_right.attr("is-last")=="1") modify[curr_id+1] = "standalone"
										else modify[curr_id+1] = "from-right"
									}
								}
							} else {
								// moving towards left
								console.log("moving towards left")

								for( var i=start_id; i>curr_id; i-- ){
									modify[i] = "through"
								}
								if (start_img_is_standalone) modify[start_id] = "from-left"
								modify[curr_id] = "from-right";

								var img_on_left = $("div#"+(curr_id-1)+".img");
								if (img_on_left.length==1) {
									if (img_on_left.attr("event-id")!=="") {
										if (img_on_left.attr("is-first")=="1") modify[curr_id-1] = "standalone"
										else modify[curr_id-1] = "from-left"
									}
								}
							}
						}
					}
					reset_all()
	 				for (i in modify) {
	 					console.log(i, modify[i])
	 					modify_img(i, modify[i]);
	 				}
					console.log("moved" ,same_event ? "same_event" : "", start_id, curr_id)
				}
			});
			function modify_img(id, state) {
				var img = $("div#"+id+".img")
				var svg = img.find("svg")
				if (state=="from-left") {
					svg.find(".line:not(.fake)").attr("visibility","hidden");
					makeLine(svg, {"x":0,"width":{{im_half}} })
					if (svg.find(".circle:not(.fake)").length!==1) makeCircle(svg);
					else svg.find(".circle:not(.fake)").attr("visibility","visible")
				}
				else if (state=="from-right") {
					svg.find(".line:not(.fake)").attr("visibility","hidden");
					makeLine(svg, {"x":{{im_half}},"width":{{im_half}} })
					if (svg.find(".circle:not(.fake)").length!==1) makeCircle(svg);
					else svg.find(".circle:not(.fake)").attr("visibility","visible")
				} else if (state=="standalone") {
					svg.find(".line:not(.fake)").attr("visibility","hidden");
					if (svg.find(".circle:not(.fake)").length!==1) makeCircle(svg);
					else svg.find(".circle:not(.fake)").attr("visibility","visible")
				} else if (state=="through") {
					svg.find(".line:not(.fake)").attr("visibility","hidden");
					makeLine(svg, {"x":0,"width":{{im_both}} })
					svg.find(".circle").attr("visibility","hidden")
				} else if (state=="blank") {
					svg.find(".line").attr("visibility","hidden");
					svg.find(".circle").attr("visibility","hidden")
				}
			}

		})

		// SVG's must have their attributes set in a special way (not just insert raw html) which these methods facilitate
		function makeCircle(el, real) {
			el.append(makeSVG("circle", {"cx":{{im_half}}, "cy":15, "r":10, "class":"circle" + (real===true ? "": " fake")}));
		}
		function makeLine(el, attrs, real) {
			attrs['class'] = 'line' + (real===true ? "": " fake")
			attrs['height'] = 5
			attrs['fill'] = "{{fillcol}}"
			attrs['y'] = 12.5
			attrs['z-index'] = 5
			// console.log(attrs)
			el.prepend(makeSVG("rect",attrs));
		}
		function makeSVG(tag, attrs) {
            var el= document.createElementNS('http://www.w3.org/2000/svg', tag);
            for (var k in attrs)
                el.setAttribute(k, attrs[k]);
            return el;
        }











        function fix_appearance() {
        	$(".fake.seperator").attr("class", "seperator")
        	$(".line").attr("nw", function () { return this.getBBox().width})
        	$(".line").attr("nx", function () {return this.getBBox().x})
        	$(".split").unbind("click mouseenter mouseleave")
        	$(".circle").unbind("mousedown")
        	$('div.img').unbind("mousemove")
        }


        // SPLIT IMAGES CODE
		$(function() {

	        $('.split').click(function() {
	        	me = $(this)
	        	var image_id = me.closest("div.img").attr("image-id");
	        	var event_id = me.closest("div.img").attr("event-id");
	        	var dir = me.attr("split-dir");
				fix_appearance()	        	
	        	// return 0
	        	Event.split(dir, {{id}},event_id, image_id, function(status) {
	        		if (status=="success") reload_page();
	        		else {
	        			console.log(status);
	        			me.attr("fill", "red")
	        		}
	        	});
	        }).hover(function(){ 
	        	if (is_dragging) return 0;
	        	var dir = $(this).attr("split-dir");
	        	var img = $(this).closest("div.img")
	        	if (dir=="left") {
	        		makeSeperator(img, {'x':10})
	        		makeSeperator(img.prev("div.img"), {'x':{{im_both}}-10})
	        	} 
	        	if (dir=="right") {
	        		makeSeperator(img, {'x':{{im_both}}-10})
	        		makeSeperator(img.next("div.img"), {'x':10})
	        	}
	        }, function() { // hover off
	        	var img = $(this).closest("div.img")
	        	$(".fake.seperator").remove()
	        	$(".line").each(function(){
					$(this).attr({"width":$(this).attr("nw"), "x":$(this).attr("nx")});
				});
	        });

	        function makeSeperator(el, attrs) {
	        	// $(el).find(".line").attr("visibility",'hidden')
	        	attrs['fill'] = "{{fillcol}}"
	        	attrs['width'] = 5
	        	makeSeperatorLine(el, attrs);
	        	var curr_line = $(el).find(".line");
	        	// console.log( curr_line.attr("width"),  curr_line.attr("x"))
	    		curr_line.attr("width", curr_line.attr("nw")-10)
	        	if (attrs['x']<{{im_half}}) {
	        		curr_line.attr("x", curr_line.attr("nx") + 10)
	        	}
	        	return 0
	        		// curr_line.attr("width", curr_line.attr("width")-15)
	        	// attrs['fill'] = ""
	        	attrs['width'] = {{im_both-15}}

	        	attrs['x'] =  (attrs['x']>{{im_half}} ? 15 : 0)
	        	console.log(attrs)
	        	makeLine(el, attrs);
	        }
	        	
	        function makeSeperatorLine(el, attrs) {
	        	attrs['class'] = 'fake seperator'
	        	attrs['height'] = 20
	        	attrs['y'] = 5
	        	$(el).find("svg").append(makeSVG("rect",attrs));
	        }
	    })



	    // STICKY ANNOTATION BAR

	    $(function() {
	        var sticky_switch_height = $(".left-sticky").offset().top;
	        var sticky = $(".left-sticky")
	        $(window).on("scroll", function(e) {
	          if ($(window).scrollTop() > sticky_switch_height) {
	            sticky.addClass("fix-search");
	          } else {
	            sticky.removeClass("fix-search");
	          }
	        });
	        // TODO : resize sidebar height when not sticky 
	    })

	    var slides = []
	    $(function() {slides = new Array(imgs.length)})
		function openPhotoSwipe(index) {
			console.log(index)
			var pswpElement = document.querySelectorAll('.pswp')[0];
			var options = {
				shareEl: false,
				tapToClose: false,
				index: index,
				getThumbBoundsFn: function(index) {

				    // find thumbnail element
				    var thumbnail = document.querySelectorAll('img.thumbnail')[index];

				    // get window scroll Y
				    var pageYScroll = window.pageYOffset || document.documentElement.scrollTop; 
				    // optionally get horizontal scroll

				    // get position of element relative to viewport
				    var rect = thumbnail.getBoundingClientRect(); 

				    // w = width
				    return {x:rect.left, y:rect.top + pageYScroll, w:rect.width};

				}
			}
			var gallery = new PhotoSwipe( pswpElement, PhotoSwipeUI_Default, slides, options);
			// create variable that will store real size of viewport
			var realViewportWidth,
			    useLargeImages = false,
			    firstResize = true,
			    imageSrcWillChange;

			// beforeResize event fires each time size of gallery viewport updates
			gallery.listen('beforeResize', function() {
			    // calculate real pixels when size changes
			    realViewportWidth = gallery.viewportSize.x * window.devicePixelRatio;

			    // Code below is needed if you want image to switch dynamically on window.resize

			    // Find out if current images need to be changed
			    if(useLargeImages && realViewportWidth < 1000) {
			        useLargeImages = false;
			        imageSrcWillChange = true;
			    } else if(!useLargeImages && realViewportWidth >= 1000) {
			        useLargeImages = true;
			        imageSrcWillChange = true;
			    }

			    // Invalidate items only when source is changed and when it's not the first update
			    if(imageSrcWillChange && !firstResize) {
			        // invalidateCurrItems sets a flag on slides that are in DOM,
			        // which will force update of content (image) on window.resize.
			        gallery.invalidateCurrItems();
			    }

			    if(firstResize) {
			        firstResize = false;
			    }

			    imageSrcWillChange = false;

			});


			// gettingData event fires each time PhotoSwipe retrieves image source & size
			gallery.listen('gettingData', function(index, item) {
				console.log(index, item, imgs[index])
			    // Set image source & size based on real viewport width
			    if( useLargeImages ) {
			        item.src = imgs[index][4][2];
			        item.w = img_sizes.original[0],
			        item.h = img_sizes.original[1]
			    } else {
			        item.src = imgs[index][4][1];
			        item.w = img_sizes.medium[0],
			        item.h = img_sizes.medium[1]
			    }

			    // It doesn't really matter what will you do here, 
			    // as long as item.src, item.w and item.h have valid values.
			    // 
			    // Just avoid http requests in this listener, as it fires quite often

			});

		    for(var i = 0; i < imgs.length; i++) {
		    	slides[i] = {}
		    }
		    // 		mediumImage: {
		    // 		    src: imgs[i][4][1],
		    // 		    w:864,
		    // 		    h:645
		    // 		},
		    // 		originalImage: {
		    // 		    src: imgs[i][4][2],
		    // 		    w: 2592,
		    // 		    h: 1936
		    // 		}
		    // 	}
		    // }

		    gallery.init();
		}

	</script>
{% endblock %}
